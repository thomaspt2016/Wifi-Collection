{% extends 'coagent/cohome.html' %}
{% load static %}
{% block title %}
<title>Profile - {{ profile.user.get_full_name|default:profile.user.username }}</title>
{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-8">

    <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6 mb-8 flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6">
        <div class="flex-shrink-0">
            <img class="h-24 w-24 rounded-full object-cover ring-4 ring-green-500" src="{{ profile.profpic.url }}" alt="Profile Picture">
        </div>
        <div class="flex-grow text-center md:text-left">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{{ profile.user.get_full_name|default:profile.user.username }}</h1>
            <p class="text-gray-500 dark:text-gray-400">{{ profile.user.email }}</p>
            <p class="text-gray-500 dark:text-gray-400 mt-1">
                <span class="font-semibold">Building:</span> {{ profile.bulding }}, 
                <span class="font-semibold">Floor:</span> {{ profile.floor }}, 
                <span class="font-semibold">Room:</span> {{ profile.room }}
            </p>
            <p class="text-gray-500 dark:text-gray-400 mt-1">
                <span class="font-semibold">Phone:</span> {{ profile.phone }}
            </p>
        </div>
        <div class="flex-shrink-0 text-center md:text-right">
            {% if profile.user.is_active %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                    <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                    Active
                </span>
            {% else %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                    Inactive
                </span>
            {% endif %}
            <p class="text-sm text-gray-500 mt-2">Joined: {{ profile.user.date_joined|date:"d M, Y" }}</p>
        </div>
    </div>

    <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
        <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="myTab" data-tabs-toggle="#myTabContent" role="tablist">
            <li class="me-2" role="presentation">
                <button class="inline-block p-4 border-b-2 rounded-t-lg" id="billing-tab" data-tabs-target="#billing" type="button" role="tab">Billing & Payments</button>
            </li>
            <li class="me-2" role="presentation">
                <button class="inline-block p-4 border-b-2 rounded-t-lg" id="codes-tab" data-tabs-target="#codes" type="button" role="tab">WiFi Codes</button>
            </li>
        </ul>
    </div>

    <div id="myTabContent">
        <div class="hidden p-4 rounded-lg bg-white dark:bg-gray-800" id="billing" role="tabpanel">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Payment Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                {% for payment_summary in paymentmeth %}
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-sm flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ payment_summary.payment_method|title }}</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Total Amount Paid</p>
                    </div>
                    <span class="text-2xl font-bold text-green-600 dark:text-green-400">
                        ${{ payment_summary.total_amount|floatformat:2 }}
                    </span>
                </div>
                {% empty %}
                <div class="col-span-full">
                    <p class="text-center text-gray-500 dark:text-gray-400">No payment summary available.</p>
                </div>
                {% endfor %}
            </div>

            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Payment History</h2>
            <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                            <th scope="col" class="px-6 py-3">Invoice ID</th>
                            <th scope="col" class="px-6 py-3">Date</th>
                            <th scope="col" class="px-6 py-3">Amount</th>
                            <th scope="col" class="px-6 py-3">Method</th>
                            <th scope="col" class="px-6 py-3">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in profile.user.paymentsusr.all %}
                        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                            <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">{{ payment.InvoiceId }}</td>
                            <td class="px-6 py-4">{{ payment.payment_date|date:"d M, Y" }}</td>
                            <td class="px-6 py-4">${{ payment.payment_amount|floatformat:2 }}</td>
                            <td class="px-6 py-4">
                                {% if payment.payment_method == "Online" %}
                                <span class="bg-purple-100 text-purple-800 text-xs font-medium me-2 px-2.5 py-0.5 
                                rounded-sm dark:bg-gray-700 dark:text-purple-400 border border-purple-400">Online</span>
                                {% elif payment.payment_method == "Cash" %}
                                <span class="bg-green-100 text-green-800 text-xs font-medium me-2 px-2.5 py-0.5
                                 rounded-sm dark:bg-gray-700 dark:text-green-400 border border-green-400">Cash</span>
                                {% else %}
                                    {{ payment.payment_method|title }}
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                {% if payment.payment_status == "Success" %}
                                <span class="bg-green-100 text-green-800 text-xs font-medium me-2 px-2.5 py-0.5
                                 rounded-full dark:bg-green-900 dark:text-green-300">Success</span>
                                {% elif payment.payment_status == "Failed" %}
                                <span class="bg-red-100 text-red-800 text-xs font-medium me-2 px-2.5
                                 py-0.5 rounded-full dark:bg-red-900 dark:text-red-300">Failed</span>
                                {% elif payment.payment_status == "Pending" %}
                                <span class="bg-yellow-100 text-yellow-800 text-xs font-medium
                                 me-2 px-2.5 py-0.5 rounded-full dark:bg-yellow-900 dark:text-yellow-300">Pending</span>
                                {% else %}
                                    {{ payment.payment_status|title }}
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center">No payment history found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <h2 class="text-xl font-semibold mt-8 mb-4 text-gray-800 dark:text-gray-200">Plan History</h2>
            <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                            <th scope="col" class="px-6 py-3">Plan Name</th>
                            <th scope="col" class="px-6 py-3">Start Date</th>
                            <th scope="col" class="px-6 py-3">End Date</th>
                            <th scope="col" class="px-6 py-3">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for billing in profile.user.billingusr.all %}
                        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                            <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">{{ billing.billingplan.plan_name }}</td>
                            <td class="px-6 py-4">{{ billing.billstartdate|date:"d M, Y" }}</td>
                            <td class="px-6 py-4">{{ billing.billendate|date:"d M, Y" }}</td>
                            <td class="px-6 py-4">
                                {% if billing.PlanStatus == "Current" %}
                                    <span class="bg-green-100 text-green-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded">Current</span>
                                {% else %}
                                    <span class="bg-red-100 text-red-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded">Upcoming</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center">No plan history found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="hidden p-4 rounded-lg bg-white dark:bg-gray-800" id="codes" role="tabpanel">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">WiFi Codes</h2>
            <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                            <th scope="col" class="px-6 py-3">Code</th>
                            <th scope="col" class="px-6 py-3">Assigned Date</th>
                            <th scope="col" class="px-6 py-3">Expiry Date</th>
                            <th scope="col" class="px-6 py-3">Deactivated Date</th>
                            <th scope="col" class="px-6 py-3">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for code in profile.user.assigned_codes.all %}
                        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                            <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">{{ code.code }}</td>
                            <td class="px-6 py-4">{{ code.assigneddate|date:"d M, Y" }}</td>
                            <td class="px-6 py-4">{{ code.exiprydate|date:"d M, Y" }}</td>
                            <td class="px-6 py-4">
                                {% if code.deactivated %}
                                    {{ code.deactivated|date:"d M, Y" }}
                                {% else %}
                                     N/A
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                {% if code.remarks == "De-activated" %}
                                    <span class="bg-red-100 text-red-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-sm dark:bg-gray-700 dark:text-red-400 border border-red-400">Deactivated</span>
                                {% elif code.remarks == "Expired" %}
                                    <span class="bg-yellow-100 text-yellow-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-sm dark:bg-gray-700 dark:text-yellow-300 border border-yellow-300">Expired</span>
                                {% elif code.remarks == "Active" %}
                                    <span class="bg-green-100 text-green-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-sm dark:bg-gray-700 dark:text-green-400 border border-green-400">Active</span>
                                {% else %}
                                    <span class="bg-gray-100 text-gray-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-sm dark:bg-gray-700 dark:text-gray-400 border border-gray-500">Used</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center">No WiFi codes have been assigned to this user.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tabs = [];
        const tabContents = {};

        // Find all tab buttons and content panels
        document.querySelectorAll('[data-tabs-target]').forEach(button => {
            const targetId = button.getAttribute('data-tabs-target');
            const targetPanel = document.querySelector(targetId);
            if (targetPanel) {
                tabs.push(button);
                tabContents[targetId] = targetPanel;

                button.addEventListener('click', () => {
                    // Deactivate all tabs
                    tabs.forEach(tab => {
                        tab.classList.remove('border-blue-600', 'text-blue-600');
                        tab.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                    });

                    // Hide all content panels
                    Object.values(tabContents).forEach(panel => {
                        panel.classList.add('hidden');
                    });

                    // Activate the clicked tab
                    button.classList.add('border-blue-600', 'text-blue-600');
                    button.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                    
                    // Show the corresponding content panel
                    targetPanel.classList.remove('hidden');
                });
            }
        });

        // Activate the first tab by default
        if (tabs.length > 0) {
            tabs[0].click();
        }
    });
</script>

{% endblock %}
